<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serenity AI - Chatbot</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Lexend%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
        }
        .message {
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .bot-message {
            background: #f8f9fa;
            color: #333;
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.show {
            display: flex;
        }
        .listening-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .listening-overlay.show {
            display: flex;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body style='font-family: Lexend, "Noto Sans", sans-serif;'>
    <!-- Header -->
    <header class="flex items-center justify-center border-b border-solid border-b-[#ededed] py-4 bg-neutral-50">
        <div class="flex items-center gap-2">
            <img src="serenity-logo.png" alt="Serenity AI Logo" style="height:36px; width:auto;" />
            <span class="text-[#141414] text-2xl font-bold leading-tight tracking-[-0.015em]">Serenity AI</span>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex space-x-8">
                    <a href="MAin.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">Home</a>
                    <a href="2nd.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">Dashboard</a>
                    <a href="chatbot.html" class="flex items-center px-3 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">Chatbot</a>
                    <a href="4th.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">Journal</a>
                    <a href="5th.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">Meditation</a>
                    <a href="6th.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">Analytics</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 bg-gray-50 min-h-screen">
        <div class="max-w-4xl mx-auto p-6">
            <!-- Chat Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">AI Chat Assistant</h1>
                <p class="text-gray-600">Powered by Jarvis AI - Your intelligent mental health companion</p>
                <div class="mt-4 flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600" id="connection-status">Connecting to Jarvis...</span>
                    </div>
                    <button onclick="checkConnection()" class="text-sm text-blue-600 hover:text-blue-800">Refresh</button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="chat-container overflow-y-auto p-6" id="chatContainer">
                    <div class="message bot-message rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-bold">AI</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm">Hello! I'm your Jarvis AI assistant, powered by advanced AI technology. I can help you with:</p>
                                <ul class="text-sm mt-2 space-y-1">
                                    <li>â€¢ Mental health conversations and support</li>
                                    <li>â€¢ Opening applications and websites</li>
                                    <li>â€¢ Playing music and videos on YouTube</li>
                                    <li>â€¢ Managing contacts and communications</li>
                                    <li>â€¢ Voice commands and speech recognition</li>
                                </ul>
                                <p class="text-sm mt-2">How can I assist you today?</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator p-4 border-t" id="typingIndicator">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">AI</span>
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t p-4">
                    <div class="flex space-x-3">
                        <div class="flex-1 relative">
                            <input type="text" id="messageInput" placeholder="Type your message..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button onclick="sendMessage()" id="sendButton" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Send
                        </button>
                        <button onclick="startVoiceInput()" id="voiceButton" 
                                class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                            ðŸŽ¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Listening Overlay -->
    <div class="listening-overlay" id="listeningOverlay">
        <div class="text-center">
            <div class="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center pulse mb-4">
                <span class="text-white text-2xl">ðŸŽ¤</span>
            </div>
            <h3 class="text-white text-xl font-bold mb-2">Listening...</h3>
            <p class="text-white text-sm">Speak now or click to stop</p>
            <button onclick="stopVoiceInput()" class="mt-4 px-6 py-2 bg-white text-red-500 rounded-lg hover:bg-gray-100">
                Stop Listening
            </button>
        </div>
    </div>

    <script>
        const JARVIS_API_URL = 'http://localhost:8080/api';
        let isConnected = false;

        // Check connection to Jarvis
        async function checkConnection() {
            try {
                const response = await fetch(`${JARVIS_API_URL}/status`);
                const data = await response.json();
                
                if (data.status === 'running') {
                    isConnected = true;
                    document.getElementById('connection-status').textContent = 'Connected to Jarvis';
                    document.getElementById('connection-status').parentElement.children[0].className = 'w-3 h-3 bg-green-500 rounded-full';
                } else {
                    throw new Error('Jarvis not running');
                }
            } catch (error) {
                isConnected = false;
                document.getElementById('connection-status').textContent = 'Not connected to Jarvis';
                document.getElementById('connection-status').parentElement.children[0].className = 'w-3 h-3 bg-red-500 rounded-full';
                console.error('Jarvis connection failed:', error);
            }
        }

        // Send message to Jarvis
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                if (isConnected) {
                    // Get feeling from localStorage
                    let feeling = localStorage.getItem('serenity_feeling');
                    // Send to Jarvis API
                    const response = await fetch(`${JARVIS_API_URL}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(feeling ? { message: message, feeling: feeling } : { message: message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.response) {
                        addMessage(data.response, 'bot');
                    } else {
                        addMessage('Sorry, I encountered an error processing your request.', 'bot');
                    }
                } else {
                    // Fallback to local response
                    const fallbackResponse = getFallbackResponse(message);
                    addMessage(fallbackResponse, 'bot');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('Sorry, I\'m having trouble connecting to Jarvis. Please make sure the server is running.', 'bot');
            }
            
            hideTypingIndicator();
        }

        // Voice input functionality
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function startVoiceInput() {
            if (!isConnected) {
                alert('Please connect to Jarvis first to use voice input.');
                return;
            }
            
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Show listening overlay
                document.getElementById('listeningOverlay').classList.add('show');
                document.getElementById('voiceButton').disabled = true;
                
                // Initialize MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                isRecording = true;
                
                // Collect audio data
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                // When recording stops, send audio to server
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await sendAudioToServer(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // Start recording
                mediaRecorder.start();
                
                // Auto-stop after 10 seconds
                setTimeout(() => {
                    if (isRecording) {
                        stopVoiceInput();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check your browser permissions.');
                stopVoiceInput();
            }
        }

        async function sendAudioToServer(audioBlob) {
            try {
                // Create FormData to send audio file
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_input.wav');
                
                // Get feeling from localStorage
                let feeling = localStorage.getItem('serenity_feeling');
                
                // Send to Jarvis API
                const response = await fetch(`${JARVIS_API_URL}/voice-input`, {
                    method: 'POST',
                    body: formData // Don't set Content-Type header, let browser set it with boundary
                });
                
                const data = await response.json();
                
                if (response.ok && data.text) {
                    addMessage(data.text, 'user');
                    if (data.response) {
                        addMessage(data.response, 'bot');
                    }
                } else {
                    addMessage('Sorry, I couldn\'t understand what you said. Please try again.', 'bot');
                }
            } catch (error) {
                console.error('Error sending audio:', error);
                addMessage('Sorry, voice input is not working right now. Please try typing your message.', 'bot');
            }
        }

        function stopVoiceInput() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            document.getElementById('listeningOverlay').classList.remove('show');
            document.getElementById('voiceButton').disabled = false;
        }

        // Add message to chat
        function addMessage(text, sender) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message rounded-lg p-4 mb-4`;
            
            const icon = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
            const bgColor = sender === 'user' ? 'bg-blue-500' : 'bg-green-500';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">${icon}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm">${text}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Show/hide typing indicator
        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('show');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        // Fallback responses when Jarvis is not connected
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return 'Hello! I\'m your AI assistant. To get the full Jarvis experience, please start the Jarvis server.';
            } else if (lowerMessage.includes('how are you')) {
                return 'I\'m doing well, thank you for asking! I\'m here to help you with your mental health and daily tasks.';
            } else if (lowerMessage.includes('help')) {
                return 'I can help you with mental health support, opening applications, playing music, and much more. Connect to Jarvis for the full experience!';
            } else if (lowerMessage.includes('mental health') || lowerMessage.includes('anxiety') || lowerMessage.includes('stress')) {
                return 'I understand you\'re dealing with some challenges. Remember that it\'s okay to not be okay. Consider talking to a mental health professional if you need support.';
            } else {
                return 'That\'s interesting! To get more advanced responses and features, please connect to the Jarvis server.';
            }
        }

        // Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Check connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            // Check connection every 30 seconds
            setInterval(checkConnection, 30000);
        });
    </script>
</body>
</html> 